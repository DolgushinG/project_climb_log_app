# API обновления плана (PATCH) — рекомендации для бэкенда

Требования для функции «Обновить план» в приложении. Позволяет продлить активный план или изменить настройки без удаления и создания нового.

---

## Сценарии

1. **Продление:** План на 2 недели, выполнена 1 неделя — пользователь хочет добавить 3–4 недели.
2. **Изменение настроек:** Поменять дни недели, время на тренировку, лазание в днях и т.п.
3. **Комбинация:** Продлить + изменить дни/время.

---

## PATCH /api/climbing-logs/plans/{id}

**Метод:** `PATCH`  
**Авторизация:** Bearer token (как для POST plans)

**Тело запроса** — частичное обновление, все поля опциональны:

| Поле | Тип | Описание |
|------|-----|----------|
| `extend_weeks` | int | Добавить N недель к текущей end_date. Например: 2 → план станет на 2 недели длиннее |
| `duration_weeks` | int | Полная длительность от start_date (2–12). Используется, если нужна фиксированная длина, а не прирост |
| `end_date` | string | Явная новая дата окончания YYYY-MM-DD |
| `scheduled_weekdays` | int[] | Дни недели [1,3,5] — Пн, Ср, Пт |
| `available_minutes` | int | 30 \| 45 \| 60 \| 90 |
| `include_climbing_in_days` | bool | День = лазание + ОФП/СФП |
| `has_fingerboard` | bool | Есть доступ к фингерборду |
| `injuries` | string[] | ["elbow_pain", ...] |
| `preferred_style` | string | boulder \| lead \| both |
| `experience_months` | int | Стаж в месяцах |
| `template_key` | string | Смена шаблона (опционально, если бэк поддерживает) |
| `ofp_sfp_focus` | string | balanced \| sfp \| ofp — фокус ОФП/СФП. По умолчанию balanced |

**Рекомендация:** Для продления достаточно `extend_weeks`. Для полного редактирования — остальные поля по необходимости.

**Ответ 200:** объект `plan` в формате ActivePlan (как в GET plans/active):

```json
{
  "plan": {
    "id": 1,
    "template_key": "ofp_sfp_2_1",
    "start_date": "2026-02-17",
    "end_date": "2026-04-06",
    "scheduled_weekdays": [1, 3, 5],
    "scheduled_weekdays_labels": ["Пн", "Ср", "Пт"],
    "include_climbing_in_days": true
  }
}
```

**Ошибки:**

- `404` — план не найден или не принадлежит пользователю
- `400` — невалидные данные (например, extend_weeks < 1, end_date до start_date)

---

## Поведение бэкенда

1. **Выполненные тренировки** — не трогаются. Отметки `complete` остаются.
2. **extend_weeks** — новый `end_date = старый_end_date + extend_weeks * 7 дней`.
3. ** duration_weeks** — `end_date = start_date + duration_weeks * 7 дней`. Может укоротить план, если текущая длительность больше.
4. **scheduled_weekdays** — расписание пересчитывается для новых/оставшихся недель.
5. **available_minutes** — влияет на генерацию упражнений для будущих дней (GET day).

---

## Flutter: что будет отправляться

При нажатии «Обновить план» PlanSelectionScreen открывается с предзаполненными значениями активного плана. Пользователь меняет длительность, дни, время и т.д. и нажимает «Сохранить».

Фронт отправит PATCH с изменёнными полями, например:

```json
{
  "extend_weeks": 3,
  "scheduled_weekdays": [1, 3, 5, 6],
  "available_minutes": 60
}
```

Или, если выбрана полная длительность:

```json
{
  "duration_weeks": 6,
  "scheduled_weekdays": [1, 3, 5]
}
```

---

## Чеклист для бэкенда

- [ ] PATCH /api/climbing-logs/plans/{id} реализован
- [ ] Поддерживается extend_weeks (добавление недель)
- [ ] Поддерживается duration_weeks (полная длительность)
- [ ] Поддерживаются scheduled_weekdays, available_minutes, include_climbing_in_days
- [ ] Выполненные сессии (complete) не удаляются
- [ ] Ответ в формате ActivePlan
