# API: Вход по коду из почты

Спецификация для бэкенда — что нужно реализовать для работы функции «Вход по коду».

---

## Общий сценарий

1. Пользователь вводит email.
2. На email отправляется код (например, 6 цифр).
3. Пользователь вводит код в приложении.
4. Приложение отправляет код на проверку и получает токен авторизации.
5. Пользователь перенаправляется в профиль.

---

## Эндпоинты

### 1. Запрос кода на email

**Метод:** `POST`  
**URL:** `/api/auth/code/request` (или `/api/auth/email-code/send` — на усмотрение бэка)

**Request:**
```json
{
  "email": "user@example.com"
}
```

**Headers:**
```
Content-Type: application/json
```

**Response 200 (успех):**
```json
{
  "message": "Код отправлен на указанный email",
  "expires_in": 300
}
```

- `expires_in` (опционально) — время жизни кода в секундах (например, 300 = 5 минут).

**Response 4xx/5xx (ошибка):**
```json
{
  "message": "Текст ошибки для пользователя"
}
```

или
```json
{
  "error": "Текст ошибки"
}
```

**Ожидаемые ошибки:**
- `400` — невалидный email
- `429` — слишком частые запросы (см. ограничение ниже)
- `404` — email не найден в системе (если требуется регистрация)

---

### 2. Проверка кода и получение токена

**Метод:** `POST`  
**URL:** `/api/auth/code/verify` (или `/api/auth/email-code/verify`)

**Request:**
```json
{
  "email": "user@example.com",
  "code": "123456"
}
```

**Headers:**
```
Content-Type: application/json
```

**Response 200 (успех):**
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

Токен должен быть тем же форматом, что и при обычном входе (`/api/auth/token`), чтобы клиент мог использовать его так же.

**Response 4xx (ошибка):**
```json
{
  "message": "Неверный или истёкший код"
}
```

**Ожидаемые ошибки:**
- `400` — неверный код, истёкший код или невалидный email
- `404` — email не найден

---

## Ограничение частоты запросов (rate limit)

Для эндпоинта **запроса кода** (`/api/auth/code/request`):

- Не чаще **1 запроса в 30 секунд** на один email.
- При превышении — ответ `429` с телом:
  ```json
  {
    "message": "Повторный запрос возможен через 30 секунд",
    "retry_after": 25
  }
  ```
- `retry_after` (опционально) — сколько секунд осталось до возможности повторного запроса.

---

## Дополнительные требования

1. **Формат кода**
   - Рекомендуется 6 цифр (например, `123456`).
   - Код передаётся строкой, без пробелов и дефисов.

2. **Время жизни кода**
   - Рекомендуется 5–10 минут.
   - После истечения — ответ с ошибкой при проверке.

3. **Однократное использование**
   - Код должен быть недействителен после успешной проверки.

4. **Безопасность**
   - Ограничение попыток проверки кода (например, блокировка после 5 неудачных попыток на 15 минут).
   - Логирование попыток для аудита.

---

## Примеры запросов (curl)

**Запрос кода:**
```bash
curl -X POST https://climbing-events.ru/api/auth/code/request \
  -H "Content-Type: application/json" \
  -d '{"email":"user@example.com"}'
```

**Проверка кода:**
```bash
curl -X POST https://climbing-events.ru/api/auth/code/verify \
  -H "Content-Type: application/json" \
  -d '{"email":"user@example.com","code":"123456"}'
```

---

## Контракт для фронтенда (Flutter)

Фронтенд будет вызывать:

| Действие           | Метод | URL                     | Body                          |
|--------------------|-------|-------------------------|-------------------------------|
| Отправить код      | POST  | `/api/auth/code/request`| `{"email": "..."}`            |
| Проверить код      | POST  | `/api/auth/code/verify`  | `{"email": "...", "code": "..."}` |

При успешной проверке (`200`) ожидается `{"token": "..."}` — токен сохраняется и пользователь перенаправляется в профиль, как при обычном входе.
