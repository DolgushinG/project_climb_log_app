# Требования к бэкенду: пуш-уведомления RuStore

Что должен реализовать бэкенд для поддержки пушей RuStore (приложение Climbing Events, Android через RuStore).

---

## 1. Приём и хранение push-токена от приложения

### 1.1. Эндпоинт (рекомендуемый)

**POST** `/api/device/push-token` (или аналог: `/api/profile/push-token`, `/api/notifications/register` — на ваш выбор).

**Заголовки:**
- `Authorization: Bearer <JWT пользователя>`
- `Content-Type: application/json`

**Тело запроса (JSON):**
```json
{
  "token": "строка — push-токен RuStore с устройства",
  "platform": "rustore"
}
```

- `token` — обязательный; строка, которую приложение получает от RuStore SDK и передаёт на бэкенд.
- `platform` — опционально; можно использовать для отличия RuStore от других платформ (FCM и т.д.) в будущем.

**Ожидаемое поведение:**
- При успешной валидации JWT: сохранить/обновить связку «пользователь ↔ push-токен» и вернуть **200** (тело по желанию, например `{}` или `{ "ok": true }`).
- При невалидном/отсутствующем JWT: **401**.

### 1.2. Хранение на бэкенде

Нужно хранить для каждого пользователя (или для каждой «устройство + пользователь»):

- идентификатор пользователя (из JWT);
- **push-токен** (строка от RuStore);
- при необходимости: `platform = "rustore"`, дата последнего обновления.

Один пользователь может иметь несколько устройств — тогда храните несколько записей с разными токенами (или одну запись с массивом токенов, как удобнее). При повторном вызове `POST /api/device/push-token` с тем же пользователем — обновлять токен для этого устройства или добавлять новый.

При выходе пользователя из аккаунта в приложении можно вызывать удаление токена (см. ниже).

---

## 2. Отправка push-уведомления (RuStore API)

Пуши отправляются **с вашего бэкенда** в RuStore по их HTTP API.

### 2.1. Где взять данные для доступа

В [RuStore Консоль](https://console.rustore.ru) → приложение → **Push-уведомления** → **Проекты**:

- **ID проекта** (`project_id`) — уже используется в мобильном приложении в AndroidManifest.
- **Сервисный токен** (service token) — **нужен только бэкенду**; хранить в переменных окружения/секретах, не отдавать в приложение.

### 2.2. Запрос к RuStore

**Метод и URL:**  
`POST https://vkpns.rustore.ru/v1/projects/{project_id}/messages:send`

Подставить вместо `{project_id}` ваш ID проекта из консоли.

**Заголовки:**
- `Content-Type: application/json`
- `Authorization: Bearer {service_token}` — сервисный токен из консоли RuStore.

**Тело (JSON):**

Минимальный вариант (заголовок и текст):
```json
{
  "message": {
    "token": "push-токен устройства из вашей БД",
    "notification": {
      "title": "Заголовок уведомления",
      "body": "Текст уведомления"
    }
  }
}
```

Расширенный вариант (картинка, TTL, deep link и т.д.) — см. [официальную документацию](https://www.rustore.ru/help/sdk/push-notifications/send-push-notifications).

Пример с картинкой и опциональным `data`:
```json
{
  "message": {
    "token": "push-токен из БД",
    "data": {
      "screen": "competition",
      "id": "123"
    },
    "notification": {
      "title": "Новое событие",
      "body": "Началась регистрация на соревнования",
      "image": "https://example.com/image.png"
    },
    "android": {
      "ttl": "86400s",
      "notification": {
        "title": "Новое событие",
        "body": "Началась регистрация на соревнования",
        "channel_id": "default",
        "click_action": "https://yourapp.com/competition/123",
        "click_action_type": 1
      }
    }
  }
}
```

- `token` — всегда обязателен; это сохранённый на бэкенде push-токен устройства.
- Либо есть непустой `message.data`, либо обязательно одно из: `message.notification` или `message.android.notification` (в т.ч. с полями `title`/`body`).
- Размер сообщения — до 4096 байт.

### 2.3. Ответы RuStore

- **200** и пустое тело `{}` — сообщение принято к доставке.
- **400** — неверные параметры (`INVALID_ARGUMENT`).
- **401/403** — неверный сервисный токен (`PERMISSION_DENIED`).
- **404** — токен не найден или недействителен (`NOT_FOUND`). В этом случае **рекомендуется удалить этот push-токен из вашей БД**, чтобы не слать запросы повторно.
- **429** — лимит запросов (`TOO_MANY_REQUESTS`); повторить позже.

При отправке одному пользователю на несколько устройств — один запрос к RuStore на каждый push-токен.

---

## 3. Удаление токена (опционально)

Если в приложении предусмотрен «выйти из аккаунта» и вы хотите отключить пуши для этого устройства:

- Добавить эндпоинт вида **DELETE** `/api/device/push-token` с телом или query-параметром `token=...` (или передавать текущий токен из заголовка/сессии).
- По JWT определить пользователя и удалить у него сохранённый push-токен (или соответствующую запись устройства).

Приложение при выходе может вызывать этот метод, чтобы бэкенд перестал слать пуши на это устройство.

---

## 4. Краткий чек-лист для бэкенда

| Задача | Описание |
|--------|----------|
| Эндпоинт регистрации токена | POST с JWT, тело `{ "token", "platform" }`, сохранить в БД |
| Хранение | Связка user_id ↔ push-токен(ы), при необходимости платформа |
| Переменные окружения | `RUSTORE_PUSH_PROJECT_ID`, `RUSTORE_PUSH_SERVICE_TOKEN` из RuStore Консоль |
| Отправка пуша | POST `https://vkpns.rustore.ru/v1/projects/{project_id}/messages:send`, заголовок `Authorization: Bearer {service_token}`, тело — см. выше |
| Обработка 404 | При ответе NOT_FOUND от RuStore — удалить токен из БД |
| (Опционально) Удаление токена | DELETE-эндпоинт при выходе пользователя |

---

## 5. Ссылки

- [Отправка push-уведомлений (API) RuStore](https://www.rustore.ru/help/sdk/push-notifications/send-push-notifications)
- [Авторизация в RuStore API](https://www.rustore.ru/help/work-with-rustore-api/api-authorization-process)

После реализации бэкенда в мобильном приложении нужно будет добавить вызов `POST /api/device/push-token` при получении токена (в `RustorePushService._onTokenReceived`).
