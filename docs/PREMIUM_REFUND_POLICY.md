# Условия возврата Premium-подписки

**Только полный возврат до активации.** Период охлаждения не нужен — есть пробный период 7 дней.

---

## Как определить «до активации подписки»

**Активация** происходит в webhook PayAnyWay: бэкенд получает уведомление об оплате → создаёт запись в `premium_subscriptions` и связывает её с заказом.

| Ситуация | Как определить на бэкенде | Возврат |
|----------|---------------------------|---------|
| Webhook **не пришёл** | `premium_orders.status = 'pending'` (платёж инициирован, но PayAnyWay ещё не подтвердил) | — |
| Webhook **пришёл**, подписка **создана** | Есть запись в `premium_subscriptions` с `order_id` = этому заказу | Это «после активации» |
| Webhook **пришёл** (status=paid), подписка **не создана** | `premium_orders.status = 'paid'`, но **нет** строки в `premium_subscriptions`, где `order_id` или `source_order_id` = этому заказу | «До активации» — можно вернуть |

### Рекомендуемая схема в БД

**Вариант 1.** В `premium_subscriptions` есть колонка `order_id` — заказ, который активировал подписку.
```
Подписка активирована для заказа = 
  EXISTS (SELECT 1 FROM premium_subscriptions WHERE order_id = :order_id)
```

**Вариант 2.** В `premium_orders` есть флаг `subscription_activated_at` (timestamp или null).
- Webhook при создании подписки проставляет `subscription_activated_at = NOW()` для соответствующего заказа.
- `subscription_activated_at IS NULL` → «до активации».

**Вариант 3.** Связь через общую таблицу: `premium_order_activations(order_id, subscription_id)` — webhook создаёт запись при активации.

### Типичный сценарий «до активации»

- Пользователь оплатил, PayAnyWay списал деньги, но webhook **задержался** или **упал** (сетевой сбой, ошибка 500).
- В PayAnyWay операция отображается как успешная.
- На бэкенде: заказ может быть помечен `paid` (если PayAnyWay дублирует статус через другой канал) или оставаться `pending`.
- Подписка не создана → пользователь не получил доступ → полный возврат по оферте.

### Итог для `can_request_refund`

```
can_request_refund = 
  order.status = 'paid'
  AND
  NOT exists_subscription_for_this_order(order_id)
```

---

## Условия возврата (оферта)

| Условие | Возврат |
|---------|---------|
| Подписка **ещё не активирована** (оплата прошла, но доступ не предоставлен) | Полный возврат 100% |
| Подписка **активирована** | Возврат не предусмотрен |

**Обоснование:** Пользователь получает 7 дней бесплатного пробного периода — он уже попробовал продукт до оплаты. После активации подписки услуга оказана.

**Частичный возврат** не предусмотрен — только полная сумма. Упрощает работу с PayAnyWay и чеками в «Мой налог» (полное аннулирование чека).

---

## Логика для бэкенда

### `can_request_refund` в payment-history

`can_request_refund: true` только если:

1. Платёж оплачен (`status = 'paid'`)
2. **И** подписка по этому заказу **не активирована** (нет записи в `premium_subscriptions` с этим `order_id`)

### GET /api/premium/refund-preview

- Если условия не выполнены → 400 с сообщением `refund_not_allowed`
- Если выполнены → `refund_amount_rub = amount` (полная сумма, пропорциональный расчёт не нужен)
- `days_used`, `days_remaining` — можно оставить для информации, но возврат всегда 100%

### POST /api/premium/request-refund

- Проверить те же условия
- Создать заявку на **полный** возврат

---

## Текст для оферты (пример)

```
5. Возврат средств

5.1. Покупатель вправе потребовать полный возврат уплаченной суммы только в случае, если подписка на момент обращения ещё не активирована (оплата получена, но доступ не предоставлен по техническим причинам).

5.2. После активации подписки возврат средств не осуществляется — услуга считается оказанной. Перед оплатой пользователю доступен пробный период для ознакомления с функционалом.

5.3. Для оформления возврата направьте заявление на [email] с указанием номера заказа и реквизитов для возврата. Возврат производится в течение 10 рабочих дней на карту, с которой была совершена оплата.
```

---

## PayAnyWay и «Мой налог»

- **PayAnyWay:** только полный возврат — в личном кабинете или через API. Частичный возврат не используется.
- **«Мой налог»:** аннулирование чека полностью (причина «Возврат средств»). Новый чек не нужен, т.к. возврат 100%.
