# Предзагрузка плана дня (Plan Day Preload)

## Проблема

При нажатии на день в календаре плана экран загружается 5–7 секунд. Это критичный UX-момент: пользователь уже выбрал день, но ждёт ответа бэкенда.

## Запрос, который тормозит

**Основной источник задержки:**

```
GET /api/climbing-logs/plans/{plan_id}/day?date=YYYY-MM-DD
```

Это единственный запрос, который вызывается **первым** при открытии экрана дня и блокирует отображение контента. Остальные запросы (exercise-completions, exercise-skips, climbing session) выполняются только **после** получения `day` и обычно быстрее.

### Последовательность запросов при открытии дня из календаря

1. **GET /api/climbing-logs/plans/{id}/day?date=** ← **5–7 сек** (главный bottleneck)
2. GET /api/climbing-logs/... (history/session для climbing) — только если день не rest
3. GET /api/climbing-logs/exercise-completions?date=
4. GET /api/climbing-logs/exercise-skips?date=

## Рекомендации для бэкенда

### 1. Предзагрузка при показе календаря

При вызове `GET /api/climbing-logs/plans/{id}/calendar?month=YYYY-MM` возвращается список дней с типами сессий. В этот момент можно:

- **Preload:** в фоне начать генерацию/загрузку контента для видимых дней месяца (особенно сегодня, завтра, ближайшие ОФП/СФП).
- При открытии экрана дня данные уже могут быть в кэше.

### 2. Предзагрузка при скролле по календарю

Когда пользователь листает месяцы вперёд/назад — заранее запрашивать `plan/day` для дней следующего/предыдущего месяца.

### 3. Оптимизация самого endpoint'а plan/day

- Кэширование: если день уже сгенерирован, возвращать из кэша без пересчёта.
- Генерация «ленивая»: при создании плана не генерировать все дни сразу; генерировать при первом запросе, но результат кэшировать.
- Параллельная загрузка: если используются внешние сервисы (AI, рекомендации), максимально распараллеливать запросы.

### 4. Дополнительный endpoint для batch-предзагрузки

```
GET /api/climbing-logs/plans/{id}/days?dates=2026-02-19,2026-02-20,2026-02-21
```

Позволяет клиенту запросить несколько дней за один round-trip — например, при открытии календаря для текущего месяца.

---

## Сценарий использования во Flutter

- **PlanCalendarScreen** — пользователь видит календарь (вызов `getPlanCalendar`).
- Пользователь нажимает на день → **PlanDayScreen** открывается.
- PlanDayScreen вызывает `getPlanDay(planId, date)` — **этот запрос занимает 5–7 сек**.

Для предзагрузки на клиенте можно вызвать `getPlanDay` заранее (например, при наведении/долгом нажатии на ячейку календаря или при открытии календаря — для сегодняшнего дня). Но основной выигрыш даст **ускорение или предзагрузка на бэкенде**.
