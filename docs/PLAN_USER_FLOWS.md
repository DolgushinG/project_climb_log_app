# План тренировок: сценарии пользователя

Описание путей пользователя и логики «Уточнить на сегодня».

---

## 1. Карта сценариев

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  Вкладка «План» (PlanOverviewScreen)                                        │
│  • Карточка «Сегодня» (если есть план)                                      │
│  • Карточка «Предстоящая тренировка» (след. день из scheduled_weekdays)     │
│  • Блок «Даты плана» + кнопка «Календарь»                                   │
│  • Кнопки: Создать / Изменить                                               │
└─────────────────────────────────────────────────────────────────────────────┘
          │                    │                    │                    │
          ▼                    ▼                    ▼                    ▼
   [Карточка Сегодня]   [Предстоящая]       [Календарь]          [Создать/Изменить]
          │                    │                    │                    │
          ▼                    ▼                    ▼                    ▼
   PlanDayScreen         PlanDayScreen      PlanCalendarScreen   PlanSelectionScreen
   (план на день)        (план на день)    (сетка по месяцам)   (аудитория, шаблон,
          │                    │                    │             дни недели и т.д.)
          │                    │                    │                    │
          │                    │                    ▼                    ▼
          │                    │             [Тап по дню]            [Создать план]
          │                    │                    │                    │
          │                    │                    ▼                    │
          │                    │             PlanDayScreen               │
          │                    │             (план на день)             │
          │                    │                    │                    │
          └────────────────────┴────────────────────┘                    │
                               │                                        │
                               ▼                                        │
                    ┌──────────────────────┐                            │
                    │ День отдыха (rest)    │  ◄────────────────────────┘
                    │ День ОФП/СФП          │     (возврат с новым планом)
                    └──────────────────────┘
                               │
           ┌───────────────────┼───────────────────┐
           │                   │                   │
           ▼                   ▼                   ▼
   [Выполнено]         [Уточнить на сегодня]   [Растяжка]
   отметка в плане     bottom sheet            список зон
   (complete API)      feeling, focus, time
```

---

## 2. Пути пользователя (пошагово)

### 2.1. Создание плана
1. Вкладка «План» → «Создать»
2. Выбор аудитории и шаблона
3. Длительность, дата старта
4. Персонализация: дни недели (Пн/Ср/Пт), фингерборд, стиль, опыт, травмы
5. «Создать план» → план сохранён, возврат на обзор

### 2.2. Просмотр плана на сегодня
1. Вкладка «План» → «Сегодня»
2. Открывается PlanDayScreen для сегодняшней даты
3. Если день отдыха → «День отдыха», растяжка
4. Если ОФП/СФП → «Уточнить на сегодня», список упражнений, растяжка, **«Начать выполнение»** (→ ExerciseCompletionScreen с подходами и таймером отдыха), «Отметить выполненным»

### 2.3. Предстоящая тренировка
1. Вкладка «План» → «Предстоящая тренировка»
2. Показывается ближайший день из `scheduled_weekdays` (не просто завтра)
3. PlanDayScreen для этой даты

### 2.4. Календарь
1. «План» → «Календарь»
2. Сетка по месяцам: ОФП/СФП/Отдых
3. Тап по дню в плане → PlanDayScreen

### 2.5. «Уточнить на сегодня»
1. PlanDayScreen (день ОФП/СФП) → иконка «Настроить» в AppBar
2. Открывается bottom sheet:
   - **Самочувствие** 1–5
   - **Фокус**: Лазание / Сила / Восстановление
   - **Время (мин)**: 30 / 45 / 60 / 90
3. «Применить» → эти значения передаются в `GET /plans/{id}/day?feeling=3&focus=strength&available_minutes=45`
4. Бэкенд возвращает **адаптированный набор упражнений** на день
5. Экран перезагружается с новыми упражнениями

**Зачем нужно:** если пользователь уставший (1–2), мало времени (30 мин) или нужна лёгкая сессия (восстановление), бэкенд может сократить объём, заменить упражнения или смягчить нагрузку.

### 2.6. Выполнение и отметка
1. **«Начать выполнение»** → ExerciseCompletionScreen с упражнениями плана (подходы, таймер отдыха)
2. После выполнения всех подходов пользователь возвращается → автоматически вызывается `POST /plans/{id}/complete`
3. Либо «Отметить выполненным» напрямую (без прохода через экран выполнения)
4. Календарь и обзор обновляют отметки (галочка в ячейке)

### 2.7. Связь плана с лазанием
План тренировок (ОФП/СФП) и лазание (запись трасс) связаны в одном потоке «Тренировки»:

- **При создании плана**: опция «День = лазание + ОФП/СФП» (по умолчанию «Да») — типичный порядок: 1–2 ч лазания, затем силовая.
- **PlanDayScreen**: блок «1. Лазание» перед упражнениями — статус (добавлено ✓ / кнопка «Добавить»), затем «2. Упражнения».
- **Карточка «Сегодня»**: при `include_climbing_in_days` показывает «Лазание ✓» или «Лазание +».
- **После выполнения плана**: SnackBar «План выполнен! Добавить лазание?» с кнопкой «Добавить».
- **ClimbingLogAddScreen**: при открытии из плана дата предзаполнена датой плана.
- **Вкладка «Обзор»**: баннер «План на сегодня: ОФП/СФП» (если день плана) — тап открывает PlanDayScreen.

См. [BACKEND_PLAN_CLIMBING_INTEGRATION.md](BACKEND_PLAN_CLIMBING_INTEGRATION.md) для требований к бэкенду.

---

## 3. «Уточнить на сегодня» — детали

| Поле        | API-параметр   | Роль                                                |
|------------|----------------|------------------------------------------------------|
| Самочувствие | `feeling` 1–5 | 1–2 → меньше нагрузки, 5 → полный объём             |
| Фокус      | `focus`        | climbing / strength / recovery — сдвиг баланса       |
| Время      | `available_minutes` | 30–90 мин — меньше упражнений при меньшем времени |

После «Применить» вызывается `_load()` с новыми значениями — бэкенд возвращает план дня с учётом этих параметров. Если бэкенд не использует их, список упражнений не изменится.

---

## 4. Доработка: экран упражнений как в «Выполнить упражнения»

**Текущее состояние:** PlanDayScreen показывает упражнения списком (название, подходы×повторы) и одну кнопку «Отметить выполненным».

**Желаемое:** как в ExerciseCompletionScreen:
- Чекбоксы по подходам (1 подход, 2 подход, …)
- Таймер отдыха между подходами (90 сек, 2 мин и т.п.)
- Возможность отмечать каждый подход отдельно

**Что нужно:**

1. **Расширение модели PlanDayExercise** (бэкенд): добавить поле `rest` (например `"90s"`, `"2m"`) — по умолчанию 90–120 сек.
2. **Состояние подходов на экране:** `Map<String, List<bool>>` — для каждого упражнения список флагов «подход выполнен».
3. **Таймер отдыха:** копировать логику из ExerciseCompletionScreen (`_startRestTimer`, `_restSecondsRemaining`).
4. **Отметка выполненным:** либо оставить одну кнопку «Выполнено» в конце, либо считать день выполненным, когда все подходы отмечены (опционально).

---

## 5. Сводная таблица экранов

| Экран             | Вход                         | Действия                                      |
|-------------------|------------------------------|-----------------------------------------------|
| PlanOverviewScreen| Вкладка «План»               | Сегодня, Предстоящая, Календарь, Создать/Изменить |
| PlanCalendarScreen| Кнопка «Календарь»           | Навигация по месяцам, тап по дню              |
| PlanDayScreen     | Карточка или тап по дню      | Упражнения, растяжка, Уточнить, Выполнено     |
| PlanSelectionScreen| Создать/Изменить            | Выбор плана и персонализация                  |
