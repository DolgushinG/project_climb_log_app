# Бэкенд: персонализация планов тренировок

Данные от фронта для более точного подбора плана и упражнений.

---

## 1. POST /api/climbing-logs/plans — расширенное тело

Фронт передаёт дополнительные поля (все опциональны):

| Поле | Тип | Описание |
|------|-----|----------|
| `days_per_week` | int | 2–6 — сколько дней готов тренироваться |
| `scheduled_weekdays` | int[] | [1–7] — какие дни. **ISO 8601:** 1=Пн, 2=Вт, 3=Ср, 4=Чт, 5=Пт, 6=Сб, 7=Вс. НЕ использовать Sunday=1 (американская схема). |
| `ofp_weekdays` | int[] | *Опционально.* Дни для ОФП (при режиме «Указать вручную»). Подмножество `scheduled_weekdays`. |
| `sfp_weekdays` | int[] | *Опционально.* Дни для СФП (при режиме «Указать вручную»). Подмножество `scheduled_weekdays`. Не пересекается с `ofp_weekdays`. |
| `has_fingerboard` | bool | Есть фингерборд → включать СФП на фингерборде |
| `injuries` | string[] | elbow_pain, finger_pain, shoulder_pain, wrist_pain — исключить/заменить упражнения |
| `preferred_style` | string | boulder \| lead \| both — стиль лазания |
| `experience_months` | int | 1–60 — стаж тренировок в месяцах |
| `include_climbing_in_days` | bool | День = лазание + ОФП/СФП (типичный порядок). По умолчанию true. См. [BACKEND_PLAN_CLIMBING_INTEGRATION.md](BACKEND_PLAN_CLIMBING_INTEGRATION.md) |

**Пример:**
```json
{
  "template_key": "amateur",
  "duration_weeks": 4,
  "start_date": "2026-02-17",
  "days_per_week": 3,
  "scheduled_weekdays": [1, 3, 5],
  "has_fingerboard": true,
  "injuries": ["elbow_pain"],
  "preferred_style": "both",
  "experience_months": 12
}
```

**Рекомендации для бэкенда:**
- `days_per_week` — ограничить/распределить сессии в календаре
- `scheduled_weekdays` — размещать ОФП/СФП только в эти дни; остальные дни плана = rest
- `ofp_weekdays`, `sfp_weekdays` — если переданы: явное назначение. ОФП только в `ofp_weekdays`, СФП только в `sfp_weekdays`. Остальные дни из `scheduled_weekdays` — climbing-only. `ofp_sfp_focus` при этом не передаётся и игнорируется. Если не переданы — авто (бэк распределяет по шаблону, учитывает `ofp_sfp_focus`).
- `has_fingerboard: false` — заменить висы на фингерборде на альтернативы (турник, эспандер)
- `injuries` — исключить нагрузку на травмированные зоны, добавить профилактику
- `preferred_style` — смещать баланс ОФП/СФП (болдер — больше тяги, труд — выносливость)
- `experience_months` — новички (< 6) — щадящая прогрессия; опытные — выше интенсивность

---

## 2. GET /api/climbing-logs/plans/{id}/day — опциональные query-параметры

Фронт может передать при запросе плана на день:

| Параметр | Тип | Описание |
|----------|-----|----------|
| `feeling` | int | 1–5 — самочувствие (1 = плохо, 5 = отлично) |
| `focus` | string | climbing \| strength \| recovery — фокус сессии |
| `available_minutes` | int | 30, 45, 60, 90 — доступное время |

**Пример:**
```
GET /api/climbing-logs/plans/1/day?date=2026-02-17&feeling=3&focus=strength&available_minutes=45
```

**Рекомендации:**
- `feeling` 1–2 — снизить объём, убрать тяжёлые упражнения
- `focus: recovery` — лёгкая растяжка, мобильность, без силовых
- `focus: strength` — акцент на СФП, меньше кардио
- `available_minutes` — сократить количество упражнений под время

---

## 3. GET /plans/active — дни недели

Чтобы показать «Пн, Ср, Пт», бэкенд может вернуть в ответе:

```json
{
  "id": 1,
  "template_key": "amateur",
  "start_date": "2026-02-17",
  "end_date": "2026-03-17",
  "scheduled_weekdays": [1, 3, 5]
}
```

`scheduled_weekdays` — массив номеров дней недели: **1=Пн, 2=Вт, 3=Ср, 4=Чт, 5=Пт, 6=Сб, 7=Вс** (ISO 8601, как в Dart/Java).

**Частая ошибка:** если бэкенд использует Sunday=1 (Пн=2, Вт=3, …), при выборе Пн/Ср/Пт фронт отправит [1,3,5], а отображение получится Вт/Чт/Вс. Нужно хранить и возвращать числа без смещения.

**Важно:** Бэкенд должен сохранять и возвращать `scheduled_weekdays` в том же формате (1=Пн … 7=Вс) при создании плана (POST /plans) и в GET /plans/active.

---

## 4. GET /plans/{id}/calendar — сессии по дням

Для отображения календаря фронт ожидает в `days` массив объектов. **Иконки (ОФП/СФП/отдых) показываются только для дат между start_date и end_date плана** — даты до старта и после окончания плана отображаются серыми, без иконок.

| Поле | Тип | Описание |
|------|-----|----------|
| `date` | string | YYYY-MM-DD |
| `session_type` | string | ofp \| sfp \| rest |
| `completed` | bool | **Только true, если пользователь реально отметил выполнение (POST /plans/{id}/complete). Не ставить true для всех прошедших дат по умолчанию.** |
| `in_plan_range` | bool | Дата входит в план |
| `day_of_week` | int | 0–6 (опц.) |

| session_type | Описание |
|--------------|----------|
| `ofp` | ОФП-сессия |
| `sfp` | СФП-сессия |
| `rest` | День отдыха |

**Требования:**
- Дни, входящие в `scheduled_weekdays`, должны иметь `session_type`: `ofp` или `sfp` (не `rest`).
- Дни вне `scheduled_weekdays` в диапазоне плана — `rest`.
- Если бэкенд возвращает все дни как `rest` или не возвращает `ofp`/`sfp`, это ошибка бэкенда — календарь показывает только дни отдыха.
- **`completed`** — только для дат, по которым был вызван POST /plans/{id}/complete. Нельзя помечать все прошедшие даты как выполненные по умолчанию.

---

## 5. Сохранение в профиле (опционально)

Бэкенд может сохранять `days_per_week`, `has_fingerboard`, `injuries`, `preferred_style`, `experience_months` в профиль пользователя при создании плана. Тогда при следующем создании плана фронт может предложить «использовать прошлые настройки» или загрузить их с сервера.

---

## 6. Данные из других источников

Бэкенд уже может иметь:
- `body_weight`, `dead_hang_seconds`, `max_pullups` — из замеров
- `sessions_last_7_days`, `average_grade` — из climbing log
- `weekly_fatigue_sum` — текущая нагрузка

Их можно комбинировать с новыми полями для персонализации.
